---
//@ts-nocheck
import Layout from "../../layouts/Layout.astro";
import pb from "../../utils/pb";
import { Collections } from "../../utils/pocketbase-types";
import { ui } from "../../i18n/ui.js";

const locale = (Astro.locals.lang as "en" | "fr") ?? "en";
const user = Astro.locals.user;

// Récupère uniquement les SVGs de l'utilisateur connecté
const svgList = await pb.collection(Collections.Svgs).getFullList({
  sort: "-created",
  filter: `user = "${user.id}"`,
});
---

<Layout title={ui[locale].gallery.title}>
  <h1 class="text-2xl font-bold mb-4">{ui[locale].gallery.title}</h1>

  {
    svgList.length === 0 ? (
      <p class="text-gray-500">{ui[locale].gallery.noSvgs}</p>
    ) : (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {svgList.map((s) => (
          <div class="border rounded-xl p-4 bg-base-200 flex flex-col">
            <div class="flex justify-between items-start mb-2">
              <h2 class="font-semibold">{s.name}</h2>
              <span class="text-xs text-gray-500">{new Date(s.created).toLocaleDateString()}</span>
            </div>

            <div class="svg-container mb-2 flex justify-center items-center border rounded p-2" set:html={s.code_svg} />

            <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto mb-2">
              {s.code_svg}
            </pre>

            <div class="flex flex-wrap gap-2">
              <!-- Copier le code -->
              <button
                class="btn btn-sm btn-outline"
                type="button"
                onclick={`navigator.clipboard.writeText(${JSON.stringify(s.code_svg)})`}
              >
                {ui[locale].gallery.copyButton}
              </button>
              
              <!-- Télécharger le SVG -->
              <a
                class="btn btn-sm btn-primary"
                href={`data:image/svg+xml;charset=utf-8,${encodeURIComponent(s.code_svg)}`}
                download={`${s.name || "svg"}.svg`}
              >
                Télécharger
              </a>
            </div>
          </div>
        ))}
      </div>
    )
  }
</Layout>
